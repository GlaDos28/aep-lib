# Ассимиляция & Эквализация

***Процесс АЭ*** (***A&E process***, ***процесс ассимиляции и эквализации***) - комплексный процесс, задачей которого ставится выборка общих признаков (атрибутов) множества объектов, выбранных по некоторому критерию (предикату), а затем принятия этих признаков как устоявшихся для данного критерия, с дальнейшей стабилизацией значений устоявшихся признаков по зафиксированным значениям.

Исходя из определения практически ничего нельзя понять, оно, скорее, дано для формальности. Далее подробно объяснены суть задачи и её решение.

### Постановка задачи

--STUB START--
~~В игре, в особенности которая использует процедурную генерацию объектов (например, мобов - NPC), зачастую стоит проблема того, что существующие в данный момент на сцене объекты, и объекты, которые будут добавлены (или сгенерированы) в процессе геймплея, "живут каждый своей жизнью". В данном случае имеется в виду несвязность объектов друг между другом: например, на одном участке сцены могут находиться принципиально разные, намешанные по своим характеристикам NPC, которые вместе смотрятся как некоторая нелепость, как будто в данный участок сцены просто напихали абсолютно случайных мобов. Хорошо, мы можем, разумеется, проклассифицировать мобов так, чтобы они появлялись в определённых местах каждый, в зависимости от характеристик. Но проблема стоит глубже: отсутствует некоторое коллективное влияние объектов на ариал, в котором они находятся, не хватает некоторой связи между объектами и местом, в котором они все обитают, чтобы геймплей был "более живой", т.е. интерактивный.~~

~~На самом деле основная особенность, которая может быть добавлена в игру благодаря изложенной здесь теории, это возможность влияния NPC на ареал, в котором они обидают, и друг на друга. Мы говорим об интерактивном влиянии, т.е. происходящем прямо во время игры. Причём это влияние не задаётся строго - NPC в каком-то смысле порождают его исходя из текущих своих признаков, особенностей, и в каждый момент времени состояние среды может меняться, в зависимости от того, кто в ней обитает и что происходит. Приведённая здесь теория может быть использована более обще, чем приведённый выше аргумент, однако пока что основным примером работы служит именно влияние на NPC и среду в зависимости от ареала, в котором они находятся.~~
--STUB END--

###### Подробный пример

Представим, что мы имеем некоторое пространство на карте, куда мы заселили некоторое количество разных мобов (например, мы их сгенерировали). Для простоты изложения допустим, что мобы не могут выходить на некоторый предел от места, где они появились, назовём это место биомом. Изначально биом практически ничем не характеризуется, разве что некоторым дизайном.

Наш процесс предполагает следующее. Проходит время, после которого у мобов в биоме фиксируются закономерности между собой по некоторым признакам. Например, могло так случайно получиться, что большая часть мобов имеет схожий сцет кожи -  синеватого оттенка. Данный признак можно назвать окраской. После выборки и фиксации схожих признаков происходит усваивание признаков как мобами, так и биомом. Усваивание можно рассматривать как дальнейшее соблюдение признаков всеми мобами. В частности, как только синеватый оттенок окраски зафиксировался как устоявшийся признак, окраска всех мобов будет со временем стремиться к такому же синеватому. Более того, если мы добавим в биом нового моба, то все устоявшиеся признаки у нового моба будут по значению стремиться к значениям, выбранным в качестве устоявшихся (окраска есть устоявшийся признак, а синеватый оттенок - устоявшееся значения данного признака). Процесс выбора устоявшихся значений называется *ассимиляцией*, а процесс постепенного приобритения схожих признаков на основе устоявшихся называется *эквализацией*.

В конце примера можно добавить то, что устоявшиеся признаки (а точнее их значения) постоянно колеблются в зависимости от значения этого признака у всех мобов в биоме в целом. Как вывод, если произойдёт так (к примеру, из-за внешнего фактора), что у большинства мобов изменится окраска на некоторую величину, то устоявшееся значения поменяется в соответствии с новым, а если после спонтанного изменения окраски значения оттенка кожи будут разниться слишком сильно между мобами, то признак окраски в прицнипе перестанет быть устоявшимся, и процесс стабилизации окраски мобов прекратится.

### Прелиминарии

Итак, подойдём к теории более формально. В процессе изложения будут вводиться термины, призванные придать строгость тезису и упрощать повествование содержимого текста.

Для начала разберёмся, что из себя могут представлять признаки объектов, да и что мы понимаем под объектов в целом.

***Атрибут*** - именованая единица данных, описывающая некоторое логическое свойство и имеющая примитивный тип или состоящая из композиции примитивных атрибутов. ***Значение атрибута*** есть значение соответствующего типа данных. Далее под атрибутом, исходя из контекста, может подразумеваться значение атрибута. Типичными примерами типов данных являются целое число, строка, цвет как композиция трёх целых чисел от 0 до 255, и так далее.

***Признаком*** назовём атрибут, который может стать устоявшимся в контексте процесса A&E. Как вывод, не все атрибуты являются признаками, например, позиция объекта не является признаком, так как было бы странно, если бы из-за выбора устоявшегося среднего значения положения объектов последние начали бы "стягиваться" в одну [устоявшуюся] точку, хотя выбор признаков среди атрибутов ложится на разработчика и формально не ограничивается.

***Объект*** есть набор атрибутов. В принципе, в игре объект может иметь помимо атрибутов другие дополнительные характеристики (описание передвижения, наличие ИИ и др.), но в рамках процесса A&E они не имеют значения, до тех пор пока они не будут представлены как атрибуты и не включены в рассмотрение.

Признак называется ***устоявшимся***, если за заданный временной интервал разброс значения признака среди объектов не превосходит заданного порога. Устоявшийся признак имеет своё ***устоявшееся значение*** как значение атрибута.

За время процесса A&E устоявшиеся значения постоянно изменяются хотя бы на небольшую величину. Изменение устоявшегося значения (при сохранении признака как устоявшегося) называется ***корректировкой***, или ***поправкой*** устоявшегося значения.

***Ассимиляция*** - процесс, в ходе которого происходит выборка устоявшихся признаков, а также исключение уже устоявшихся признаков или поправка устоявшихся значений.

***Эквализация*** - корректировка значений атрибутов объекта в соответствии с устоявшимися значениями устоявшихся признаков.

### Выборка признаков

Процесс ассимиляции происходит наряду с процессом геймплея. В теории можно считать, что запуск всего процесса A&E осуществляется каждую итерацию, до или после итерации обновления мира в текущий момент времени. В реальности рекомендуется использовать некоторый параметр `delta`, который определяет временное значение, которое прошло с момента последнего проведения процесса, а сам процесс запускать гораздо реже, чтобы не тратить вычислительные ресурсы. Такое допущение объясняется тем, что за одну итерацию происходит сравнимо мало изменений, т.е. шанс добавления или исключения признака и величина поправки устоявшегося значения пренебрежительно малы.

###### Схема процесса

1. Процесс начинается с приёма входных данных. На вход подаётся список всех объектов сцены (в теории, на практике допускаются оптимизации), а также специальный объект, который можно назвать ***объектом среды***, начинающий использоваться с пункта 3. Объекты фильтруются по заданной функции, называемой ***критерием***, или ***предикатом*** процесса A&E (например, принадлежность объекта некоторой области карты, биому). Объекты, прошедшие фильтрацию, проходят проценсс дальше, остальные отбрасываются из рассмотрения.

2. Для A&E определён список признаков. Каждый признак имеет соответствующее ему ***пороговое значение*** (***threshold***), или просто ***порог***, определяющий максимальный разброс значений признака как атрибута. По каждому признаку и набору объектов вычисляется разброс значений:
	- для числовых примитивных значений (int, double и др.) разброс есть среднее линейное отклонение, т.е. сумма модулей разницы значений и их среднего арифметического, делённая на количество значений;
	- для строковых, булевых и других перечисляемых из некоторого конечного набора констант это максимум из отношений количества объектов, имеющих определённую константу, к количеству объектов;
	- для композитных объектов это композиция разбросов его составляющих.

Разумеется, пороговое значение по типу совпадает с типом разброса. Признаки, укладывающиеся в пороговое значение, проходят обработку дальше, остальные отбрасываются. Наряду с признаком с ним в пару идёт среднее значение, которое является средним арифметическим, модой или композицией, в соответствии с типом данных.

3. Далее идёт работа с метаданными, то есть требуется некоторое хранение состояния. Всё хранение происходит в объекте среды, переданном как входной параметр. Для ещё не устоявшихся признаков хранится временной интервал, который определяет, сколько времени признак непрерывно проходит по пороговому значению (т.е. до выходящего набора п.2). Для каждого признака из объединения набора признаков п.2 и набора текущих устоявшихся признаков производится следующее:
	- если признак входит в набор п.2, признак не является устоявшимся, и временной интервал не превышает контрольного порого времени (называемого ***временем принятия*** признака), то временной интервал увеличивается;
	- если признак входит в набор п.2, признак не является устоявшимся, и временной интервал превысил время принятия, то он становится устоявшимся, его устоявшимся значением становится вычисленное среднее значение, а временной интервал обнуляется;
	- если признак входит в набор п.2, и признак является устоявшимся, то происходит корректировка устоявшегося значения на вычисленное среднее значение;
	- если признак не входит в набор п.2 (как вывод, является устоявшимся), то признак исключается из набора устоявшихся.

### Стабилизация значений

После ассимиляции, используя обновлёные данные об утоявшихся признаках и их устоявшихся значениях, начинается второй процесс - эквализация. Данный процесс отвечает за непосредственное влияние устоявшихся значений на атрибуты объектов, причём не всегда прямым образом.

###### Схема процесса

1. Процесс принимает на вход множество устоявшихся признаков с соответствующими устоявшимися значениями. Для каждого признака заранее определяется функция, задающая влияние значения устоявшегося признака на атрибуты объекта;
2. Для каждого объекта, отфильтрованного по предикату процесса A&E, а также для объекта среды, вызываются функции, соответствующие своим устоявшемся признакам. При этом:
	- функция называется ***прямым воздействием*** (***direct impact***), если она воздействует на атрибут, соответствующий устоявшемуся признаку, от которого вызвана функция;
	- функция называется ***косвенным воздействием*** (***indirect impact***), если она воздействует на атрибут, не являющийся атрибутом устоявшегося признака, от которого вызвана функция;
	- функция называется ***мультивоздействием*** (***multi-impact***), если она воздействует на два и более атрибутов;

Любое воздействие должно постепенно стабилизировать значение атрибута(-ов), на которое(-ые) меняет, то есть для числовых типов данных это постепенное приближение числа к некоторому заданному, для перечисляемых констант это изменение значения на некоторую константу с течением некоторого времени, а для компонентных типов покомпонентное стремление. Когда воздействие косвенное, оно неявно задаёт отображение предельного значения признака (оно же устоявшееся значение) на предельное значению зависимого атрибута. Если воздействие прямое, то такое отображение тождественно, т.е. не требуется.

###### Примеры

Рассмотрим уже начатый пример про окраску моба. Пусть имеется устоявшийся признак окраски, а его устоявшееся значение - некоторый синеватый оттенок. Если влияние данного устоявшегося признака описывается тем, что окраска всех мобов будет постепенно приобретать тот же отттенок, то такое воздействие прямое, т.е. устоявшийся признак окраски влияет на свой же атрибут каждого конкретного моба. Кстати, из-за этого на следующей итерации устоявшееся значение окраски может немного измениться.

Более интересный случай такой, что мы можем потребовать, чтобы устоявшийся признак окраски не влиял на окрасу уже существующих мобов в биоме, но влиял на мобов, которые будут сгенерированы позже в данном биоме. Для этого достаточно в объекте среды (отвечающем биому) завести атрибут, характеризующий окраску моба при дальнейшей генерации новых мобов в биоме. Мы видим, что устоявшийся признак вляет уже не на свой атрибут окраски, а на некоторый специально выделенный в биоме атрибут, отвеающей за окраску моба при генерации, поэтому такое воздействие является косвенным. Стоит заметить, что в данном случае никаких манипуляций с преобразованием значений не осуществляется, т.е. по факту окраска моба и окраска потенциального моба биома имеют одну и ту же логику и, что более важно, одни единицы измерения. Иногда для более нетривиальных косвенных воздействий приходится переводить значения. К примеру, может потребоваться домножать число, соответствующее изменению значения атрибута в единицах устоявшегося признака, на некоторую константу, после чего мы получаем изменение значение атрибута уже в единицах самого изменяемого атрибута.

Мультивоздействие это композиция косвенных взаимодействий, одно из которых может быть прямым, соответственно и производится поэлементно.

### Структура параметров процесса A&E

1. Предикат: функция, принимающая объект, возвращающая `true` или `false`;
2. Набор названий признаков;
3. Для каждого признака пороговое значение;
4. Для каждого признака время принятия;
5. Для каждого признака функция воздействия, принимающая `delta`, объект и устоявшееся значение и изменяющая некоторый набор атрибутов входного объекта в соответствии с устоявшимся значением признака.